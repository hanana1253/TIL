# Javascript

## 비동기 서버통신

### XMLHttpRequest 객체로 서버통신
- 지난 시간에 이어 XMLHttpRequest 객체를 통해 서버에 요청을 보내고 응답을 받아 처리해보자.

#### get 함수 복습
- GET 요청을 하는 비동기함수 get은 다음과 같다.
  - 엔드포인트를 url로 받아 서버로부터 정보를 가져오게 한다.
  - 서버로부터 받은 응답을 파싱하여 콜백함수의 인자로 넘기도록 한다.
  - 이 함수는 fetchTodos 함수에서 호출하면서, '/todos' 엔드포인트와 setTodos 콜백 함수를 인자로 넘긴다.
```javascript
// GET '/todos'
const get = (url, callback) => {
    const xhr = new XMLHttpRequest()

    xhr.open('GET', url);
    xhr.send();

    xhr.onload = () => {
        if (xhr.status === 200){
            callback(JSON.parse(xhr.response));
        } else {
            console.log(xhr.status, xhr.statusText);
        }
    }
}
```

#### post 함수 만들기
- 새로운 데이터를 넣는 addTodo 함수는 post를 호출한다.
- get과 동일하게 xhr 객체를 만들고 요청을 날리지만, 이번에는 payload가 있다는 점이 다르다.
  - payload의 매개변수 순서는 어디가 될까? 보통은 callback을 마지막에 넣어주니까 그 앞에 넣어주자. 
    - 비동기 처리 성공 콜백과 실패 콜백 두개가 올 수도 있고, 콜백이 중간에 있으면 함수라고 인지하지 못할 수도 있으니.
    - 그러나 node.js 진영에는 콜백을 맨 앞에 넣어주는 것이 좋다고 하는 사람들도 있다.
  - payload에 대한 메타데이터 또한 요청의 header에 세팅해줘야 한다. (`xhr.setRequestHeader({헤더에 담길 키와 값})`)
- 응답 상태코드도 200 뿐 아니라 201(created)이 넘어올 수 있다. (post한 데이터를 무사히 만들었다는 뜻)

```javascript
// POST '/todos'
const post(url, payload, callback) {
  const xhr = new XMLHttpRequest();
  
  xhr.open('POST', url);
  xhr.setRequestHeader('content-type', 'application/json');
  xhr.send(JSON.stringify(payload));

  xhr.onload = () => {
    if (xhr.status === 200 || xhr.status === 201) {
      callback(JSON.parse(xhr.response));
    } else {
      console.log(xhr.status, xhr.statusText);
    }
  }
}
```
- 서버에는 다음과 같이 post 요청에 대한 응답 로직을 마련해둔다.
  - 요청 Request 객체의 body에는 payload가 들어있다. 이를 todos에 넣어준 후 todos 배열을 다시 보내준다.
```javascript
// server.js
const express = require('express');
const app = express();

// mock data
let todos = [ {...}, {...}, {...} ];

app.use(express.static('public'));
app.use(express.json());

// 'GET' 요청에 대한 응답 로직
app.get('/todos', (req, res) => {
  res.send(todos)
});

// 'POST' 요청에 대한 응답 로직
app.post('/todos', (req, res) => {
  const newTodo = req.body;
  todos = [ newTodo, ... todos ];

  res.send(todos);
});
```
- post를 호출하는 addTodo 함수에 setTodos 함수와 함께 넣어주도록 하자. 
```javascript
// state.js

const addTodo = content => {
  post('/todos', { id: generateNextId(), content, completed: false }, setTodos);
}
```

#### patch 함수 만들기
- 있는 데이터를 변경하는 것은 'PATCH' HTTP 메서드를 사용한다. 
  - todos에서는 toggleAll과 toggleTodoCompleted, updateTodoContent 등에서 쓰인다.
- patch함수에서는 id를 통해 변경할 데이터를 식별하고 그 데이터에 변경하여 갱신할 새로운 값, 즉 payload를 전달한다.
  - payload 있으니 `setRequestHeader`로 헤더 세팅
  - toggleAll은 id값 없이 그냥 '/todos'로 보내면 모든 데이터의 completed 값을 반전시킬 수 있다. 하지만 그래도 가독성과 일관성을 위해 completed 값을 payload로 보내자.
```javascript
const patch = (url, payload, callback) => {
  const xhr = new XMLHttpRequest();
  xhr.open('PATCH', url);
  xhr.setRequestHeader('content-type', 'application/json');
  xhr.send(JSON.stringify(payload));

  xhr.onload = () => {
    if (xhr.status === 200) {
      callback(JSON.parse(xhr.response));
    } else {
      console.log(xhr.status, xhr.statusText);
    }
  };
};
```
- 이 patch 함수는 server에서는 id를 가지고 들어오는 요청과 아닌 요청을 달리 처리한다.
  - id는 payload가 아닌 endpoint로 들어온다. 엔드포인트의 parameter로 넘어오는 정보는 키와 값으로 짝지어져있다
  - request 객체의 params라는 프로퍼티를 통해 이 키와 값을 갖는 객체를 참조할 수 있다.
```javascript
// server.js

// 모든 completed 값을 변경하는 toggleAll 함수의 요청
app.patch('/todos', (req, res) => {
  const { completed } = req.body

  todos = todos.map(todo => ({ ... todo, completed }));
  res.send(todos);
});

// id로 들어온 값의 completed나 content만 변경
app.patch('/todos/:id', (req, res) => {
  const { id } = req.params;
  const payload = req.body;
  // payload는 { completed: true }나 { content: React } 등의 형태로 되어있다.
  todos = todos.map( todo => todo.id === +id ? { ... todo, payload } : todo );
  res.send(todos);
});
```
- 이 함수들을 이제 toggleAll과 toggleTodoCompleted, updateTodoContent에 넣어쓰면된다.
```javascript
// payload 보낼 필요는 없지만 비슷하게 보이게 하기 위해 e.target.checked를 받아 반전하여 넘기며 호출.
const toggleAll = completed => {
  patch('/todos', { completed }, setTodos);
}

const toggleTodoCompleted = id => {
  patch(`/todos/${id}`, setTodos);
}

const updateTodoContent = id {
  patch(`/todos/${id}`, setTodos);
}
```
